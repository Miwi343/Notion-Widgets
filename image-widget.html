<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://apis.google.com https://www.gstatic.com 'unsafe-inline' 'unsafe-eval' data: blob:;">
  <title>Random Google Photo Widget</title>
  <style>
    /* Full-page centered layout for the widget */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #photo {
      max-width: 90%;
      max-height: 90%;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    #login-button {
      font-family: Arial, sans-serif;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 20px;
    }
  </style>
  <!-- Load the Google API client library -->
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <!-- Sign In Button (visible only if not authenticated) -->
  <button id="login-button" style="display:none;">Sign in with Google</button>
  <!-- Container for the random photo -->
  <img id="photo" src="" alt="Random Photo" style="display:none;">
  
  <script>
    // Your Client ID from Google Cloud Console
    const CLIENT_ID = '181865499400-j3pdfgplk3hph2knbgh227trngp92eac.apps.googleusercontent.com'; 
    const DISCOVERY_DOCS = ["https://photoslibrary.googleapis.com/$discovery/rest?version=v1"];
    const SCOPES = 'https://www.googleapis.com/auth/photoslibrary.readonly';

    // Initialize the Google API client library
    function initClient() {
      gapi.client.init({
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(() => {
        // Listen for sign-in state changes.
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
        // Handle the initial sign-in state.
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        // Set sign in button click handler.
        document.getElementById('login-button').onclick = handleAuthClick;
      }, (error) => {
        console.error('Error initializing gapi:', error);
      });
    }

    // Called when the signed in status changes.
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        document.getElementById('login-button').style.display = 'none';
        loadRandomPhoto();
      } else {
        document.getElementById('login-button').style.display = 'block';
        document.getElementById('photo').style.display = 'none';
      }
    }

    // Sign in the user when the button is clicked.
    function handleAuthClick() {
      gapi.auth2.getAuthInstance().signIn();
    }

    // Fetch a list of photos and display a randomly selected one.
    function loadRandomPhoto() {
      // Request up to 100 media items from the user's library.
      gapi.client.photoslibrary.mediaItems.list({
        pageSize: 100
      }).then((response) => {
        const items = response.result.mediaItems;
        if (!items || items.length === 0) {
          console.log('No photos found.');
          return;
        }
        // Choose a random photo.
        const randomIndex = Math.floor(Math.random() * items.length);
        const photoItem = items[randomIndex];
        // Construct the URL; append parameters for desired size (optional)
        const photoUrl = photoItem.baseUrl + '=w800-h600';
        const imgElement = document.getElementById('photo');
        imgElement.src = photoUrl;
        imgElement.style.display = 'block';
      }, (error) => {
        console.error('Error fetching photos:', error);
      });
    }

    // Load the Google API client library and initialize it.
    gapi.load('client:auth2', initClient);

    // Auto-refresh every minute (60000 milliseconds)
    setInterval(() => {
      if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
        loadRandomPhoto();
      }
    }, 60000);
  </script>
</body>
</html>
