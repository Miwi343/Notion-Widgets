<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Random Google Photo Widget</title>
  <style>
    /* Full-page centered layout for the widget */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    /* Style for the photo */
    #photo {
      max-width: 90%;
      max-height: 80%;
      display: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    /* Style for buttons */
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
    }
  </style>
  <!-- Load the Google API client library -->
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <!-- Sign In Button: shown if not already authenticated -->
  <button id="login-button" style="display:none;">Sign in with Google</button>
  <!-- Random Photo Image -->
  <img id="photo" src="" alt="Random Photo">
  <!-- Skip button to manually load the next photo -->
  <button id="skip-button" style="display:none;">Skip Photo</button>

  <script>
    // Replace this with your actual OAuth Client ID from your Google Cloud Console.
    const CLIENT_ID = '181865499400-a3vmf7pdi4tdusm3go5k7f5ba4l1qfb5.apps.googleusercontent.com';
    // Discovery document for the Google Photos Library API.
    const DISCOVERY_DOC = 'https://photoslibrary.googleapis.com/$discovery/rest?version=v1';
    // Use read-only scope
    const SCOPES = 'https://www.googleapis.com/auth/photoslibrary.readonly';

    let tokenClient;      // Will hold the token client instance from GIS.
    let gapiInited = false; // Flag indicating that gapi is ready.
    let gisInited = false;  // Flag indicating that GIS is ready.

    // Initially hide both buttons.
    document.getElementById('login-button').style.display = 'none';
    document.getElementById('skip-button').style.display = 'none';

    // When gapi is loaded, initialize the client.
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    // Initialize gapi client using discovery document.
    async function initializeGapiClient() {
      try {
        await gapi.client.init({
          // Optionally, you can add an API key here if needed:
          // apiKey: 'YOUR_API_KEY',
          discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        maybeEnableButtons();
      } catch (error) {
        console.error('Error initializing gapi client:', error);
      }
    }

    // When GIS is loaded, initialize the token client.
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        // Callback will be defined later.
        callback: '',
      });
      gisInited = true;
      maybeEnableButtons();
    }

    // Enable sign-in button once both libraries have loaded.
    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        // Try to silently request a token if available (may fail if not signed in yet)
        tokenClient.requestAccessToken({prompt: 'none'});
        // If there's no token, the sign-in button will appear.
        if (!gapi.client.getToken()) {
          document.getElementById('login-button').style.display = 'block';
        }
      }
    }

    // Handle sign-in button click.
    function handleAuthClick() {
      tokenClient.callback = async (response) => {
        if (response.error) {
          console.error('Error during authentication:', response);
          return;
        }
        // Token obtainedâ€”hide the sign-in button and show the photo and skip buttons.
        document.getElementById('login-button').style.display = 'none';
        document.getElementById('skip-button').style.display = 'block';
        loadRandomPhoto();
      };

      // If no token is present, prompt the user.
      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
      } else {
        // If token exists, request silently.
        tokenClient.requestAccessToken({prompt: ''});
      }
    }

    // Fetch a list of photos and display a random one.
    async function loadRandomPhoto() {
      try {
        let response = await gapi.client.photoslibrary.mediaItems.list({
          pageSize: 100, // Adjust if needed.
        });
        const items = response.result.mediaItems;
        if (!items || items.length === 0) {
          console.log("No photos found in your Google Photos library.");
          return;
        }
        const randomIndex = Math.floor(Math.random() * items.length);
        const photoItem = items[randomIndex];
        // Construct the photo URL and optionally append parameters for desired size.
        const photoUrl = photoItem.baseUrl + '=w800-h600';
        const imgElement = document.getElementById('photo');
        imgElement.src = photoUrl;
        imgElement.style.display = 'block';
      } catch (error) {
        console.error('Error fetching photos:', error);
      }
    }

    // Set up the skip button to load the next random photo.
    document.getElementById('skip-button').onclick = loadRandomPhoto;

    // Load gapi and GIS libraries.
    gapi.load('client:auth2', gapiLoaded);

    // Load the Google Identity Services library.
    const gisScript = document.createElement('script');
    gisScript.src = "https://accounts.google.com/gsi/client";
    gisScript.defer = true;
    gisScript.onload = gisLoaded;
    document.head.appendChild(gisScript);

    // Set up the sign-in button click handler.
    document.getElementById('login-button').onclick = handleAuthClick;

    // Set auto-refresh for the photo every 30 minutes (30 * 60 * 1000 ms).
    setInterval(() => {
      if (gapi.client.getToken() !== null) {
        loadRandomPhoto();
      }
    }, 30 * 60 * 1000);
  </script>
</body>
</html>
